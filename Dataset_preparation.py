# -*- coding: utf-8 -*-
"""01_Dataset_Preparation.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1dS5W7Esuh38sSx4RUuIv4yDt7GhvoRI0

01_Dataset_Preparation.ipynb
"""

# 1. Drive 마운트

from google.colab import drive
drive.mount('/content/drive')

# 2. 라이브러리 설치

!pip install ultralytics opencv-python --quiet

# 3. YOLOv8 모델 로드 및 탐지 함수 정의

from ultralytics import YOLO
model = YOLO('yolov8s.pt')  # 실험용 데이터셋 생성에 최적

# 4. 영상 경로 설정

video_base_path = "/content/drive/MyDrive/knife_videos"

# 5. 탐지 함수 정의

import cv2
import os

def extract_knives_from_video(video_path, save_dir, conf=0.25, save_limit=50):
    os.makedirs(save_dir, exist_ok=True)
    cap = cv2.VideoCapture(video_path)
    frame_count = 0
    saved = 0

    while cap.isOpened() and saved < save_limit:
        ret, frame = cap.read()
        if not ret:
            break

        results = model(frame)
        for result in results:
            for box in result.boxes:
                cls = int(box.cls[0])
                label = model.names[cls]

                if label == 'knife':
                    x1, y1, x2, y2 = map(int, box.xyxy[0])
                    crop = frame[y1:y2, x1:x2]
                    filename = f"{save_dir}/knife_{frame_count:04d}.jpg"
                    cv2.imwrite(filename, crop)
                    saved += 1

        frame_count += 1

    cap.release()
    print(f"[{os.path.basename(video_path)}] 저장 완료: {saved}장")

# 6. 영상 리스트 반복 처리

video_files = [
    "knife01_bright_kitchen_식칼_none.mp4",
    "knife02_dark_desk_과도_none.mp4",
    "knife03_bright_livingroom_커터칼_yes.mp4",
    "knife04_bright_floor_식칼_none.mp4",
    "knife05_dark_kitchen_과도_yes.mp4",
    "knife06_bright_window_커터칼_none.mp4",
    "knife07_bright_desk_식칼_yes.mp4",
    "knife08_dark_livingroom_커터칼_none.mp4",
    "knife09_dark_floor_커터칼_yes.mp4",
    "knife10_dark_window_커터칼_yes.mp4",
    "knife11_bright_floor_커터칼_yes.mp4",
    "knife12_dark_kitchen_커터칼_none.mp4",
    "knife13_bright_window_커터칼_yes.mp4",
    "knife14_dark_floor_과도_yes.mp4",
    "knife15_bright_kitchen_과도_none.mp4",
    "knife16_bright_floor_과도_yes.mp4",
    "knife17_bright_desk_식칼_yes.mp4",
    "knife18_bright_window_커터칼_yes.mp4",
    "knife19_dark_livingroom_식칼_none.mp4"
]

for file in video_files:
    video_path = os.path.join(video_base_path, file)
    save_dir = f"/content/knives_dataset/{file.replace('.mp4','')}"
    extract_knives_from_video(video_path, save_dir)

# 생성된 데이터셋 .zip으로 압축하기 (github 올리기용)

!zip -r knives_dataset.zip knives_dataset